# Full Agent Evaluation Workflow
# Comprehensive intelligence assessment with static + dynamic testing

workflow:
  name: evaluate-agent
  description: Đánh giá toàn diện mức độ thông minh của agent
  version: "1.0"

# ════════════════════════════════════════════════════════════════════
# PHASE 1: SELECT & LOAD
# ════════════════════════════════════════════════════════════════════
phases:
  - id: select
    name: "PHASE 1: Chọn agent để đánh giá"
    steps:
      - id: 1.1
        action: list
        path: ".microai/agents/"
        pattern: "*/agent.md"
        display:
          columns: [name, version, model]
          format: table

      - id: 1.2
        action: ask
        question: "Chọn agent để đánh giá:"
        type: select
        options_from: step_1.1
        output: target_agent

      - id: 1.3
        action: read
        file: ".microai/agents/{target_agent}/agent.md"
        output: agent_content

      - id: 1.4
        action: parse_frontmatter
        content: agent_content
        output: agent_metadata

# ════════════════════════════════════════════════════════════════════
# PHASE 2: STATIC ANALYSIS (40 points)
# ════════════════════════════════════════════════════════════════════
  - id: static_analysis
    name: "PHASE 2: Static Analysis (40 points)"
    steps:
      - id: 2.1
        name: "Structure Check (10 pts)"
        action: check_structure
        checks:
          - path: ".microai/agents/{target_agent}/"
            exists: true
            points: 2
          - path: ".microai/agents/{target_agent}/agent.md"
            exists: true
            points: 2
          - path: ".microai/agents/{target_agent}/knowledge/"
            exists: true
            points: 2
          - path: ".microai/agents/{target_agent}/memory/"
            exists: true
            points: 2
          - path: ".claude/commands/microai/{target_agent}.md"
            exists: true
            points: 2
        output: structure_score
        max: 10

      - id: 2.2
        name: "Metadata Check (10 pts)"
        action: validate_metadata
        schema: ".microai/schemas/agent-v2.0.schema.yaml"
        data: agent_metadata
        checks:
          - field: agent.metadata.id
            required: true
            points: 2
          - field: agent.metadata.name
            required: true
            points: 2
          - field: agent.metadata.model
            required: true
            enum: [opus, sonnet, haiku]
            points: 2
          - field: agent.metadata.language
            required: true
            enum: [vi, en]
            points: 2
          - field: agent.persona.role
            required: true
            points: 2
        output: metadata_score
        max: 10

      - id: 2.3
        name: "Knowledge Check (10 pts)"
        action: check_knowledge
        path: ".microai/agents/{target_agent}/knowledge/"
        checks:
          - pattern: "*.md"
            min_count: 3
            points: 3
          - file: "knowledge-index.yaml"
            exists: true
            points: 2
          - search: "```"
            in: "*.md"
            min_count: 3
            message: "≥3 code examples needed"
            points: 3
          - search: "anti-pattern|don't|avoid|không nên"
            in: "*.md"
            min_count: 1
            points: 2
        output: knowledge_score
        max: 10

      - id: 2.4
        name: "Design Check (10 pts)"
        action: check_design
        data: agent_metadata
        checks:
          - field: agent.activation.steps
            min_items: 2
            points: 3
          - field: agent.menu
            min_items: 1
            points: 3
          - field: agent.persona.principles
            min_items: 2
            points: 2
          - has_external_workflows: true
            points: 2
        output: design_score
        max: 10

# ════════════════════════════════════════════════════════════════════
# PHASE 3: DYNAMIC TESTING (40 points)
# ════════════════════════════════════════════════════════════════════
  - id: dynamic_testing
    name: "PHASE 3: Dynamic Testing (40 points)"
    config:
      provider: ollama
      model: "qwen3:1.7b"
      timeout: 30
      script: ".microai/skills/development-skills/ollama/scripts/ollama-run.sh"
      prefix: "/no_think"

    steps:
      - id: 3.1
        name: "Reasoning Tests (15 pts)"
        action: run_tests
        test_file: "./knowledge/03-test-case-library.md"
        categories: [logic, multistep, edge]
        scoring:
          logic: 5
          multistep: 5
          edge: 5
        output: reasoning_score
        max: 15

      - id: 3.2
        name: "Knowledge Tests (10 pts)"
        action: run_tests
        test_file: "./knowledge/03-test-case-library.md"
        category: domain_knowledge
        agent_type: "{agent_metadata.agent.metadata.tags[0]}"
        scoring:
          domain_depth: 5
          accuracy: 5
        output: knowledge_test_score
        max: 10

      - id: 3.3
        name: "Adaptability Tests (10 pts)"
        action: run_tests
        test_file: "./knowledge/03-test-case-library.md"
        categories: [ambiguity, recovery]
        scoring:
          ambiguity: 5
          recovery: 5
        output: adaptability_score
        max: 10

      - id: 3.4
        name: "Output Quality Tests (5 pts)"
        action: run_tests
        test_file: "./knowledge/03-test-case-library.md"
        category: output
        scoring:
          format: 2
          completeness: 2
          actionability: 1
        output: output_score
        max: 5

# ════════════════════════════════════════════════════════════════════
# PHASE 4: SYNTHESIS (20 points)
# ════════════════════════════════════════════════════════════════════
  - id: synthesis
    name: "PHASE 4: Synthesis (20 points)"
    steps:
      - id: 4.1
        name: "Cross-dimension Analysis (8 pts)"
        action: analyze_consistency
        scores:
          - reasoning_score
          - knowledge_test_score
          - adaptability_score
          - output_score
        checks:
          - variance: "<0.2"
            message: "Consistent across dimensions"
            points: 4
          - balance: "no dimension < 50%"
            message: "No severe gaps"
            points: 4
        output: consistency_score
        max: 8

      - id: 4.2
        name: "Pattern Recognition (6 pts)"
        action: identify_patterns
        inputs:
          - static_scores
          - dynamic_scores
          - weaknesses_knowledge: "./knowledge/04-common-weaknesses.md"
        output:
          strengths: []
          weaknesses: []
          patterns: []
        scoring:
          clear_strengths: 3
          clear_weaknesses: 3
        output: pattern_score
        max: 6

      - id: 4.3
        name: "Confidence Level (6 pts)"
        action: calculate_confidence
        factors:
          - tests_completed: weight_0.4
          - consistency: weight_0.3
          - sample_size: weight_0.3
        output: confidence_score
        max: 6

# ════════════════════════════════════════════════════════════════════
# PHASE 5: REPORT GENERATION
# ════════════════════════════════════════════════════════════════════
  - id: report
    name: "PHASE 5: Generate Report"
    steps:
      - id: 5.1
        action: calculate_total
        scores:
          static:
            - structure_score
            - metadata_score
            - knowledge_score
            - design_score
          dynamic:
            - reasoning_score
            - knowledge_test_score
            - adaptability_score
            - output_score
          synthesis:
            - consistency_score
            - pattern_score
            - confidence_score
        output: total_score
        max: 100

      - id: 5.2
        action: assign_grade
        score: total_score
        scale:
          - range: [90, 100]
            grade: "A+"
            level: "Exceptional"
          - range: [80, 89]
            grade: "A"
            level: "Advanced"
          - range: [70, 79]
            grade: "B"
            level: "Competent"
          - range: [60, 69]
            grade: "C"
            level: "Basic"
          - range: [50, 59]
            grade: "D"
            level: "Limited"
          - range: [0, 49]
            grade: "F"
            level: "Failing"

      - id: 5.3
        action: generate_recommendations
        based_on:
          - weaknesses
          - patterns
          - improvement_guide: "./knowledge/05-improvement-patterns.md"
        output: recommendations
        max_items: 5

      - id: 5.4
        action: display
        template: "../templates/evaluation-report.md"
        data:
          agent: target_agent
          score: total_score
          grade: grade
          level: level
          breakdown:
            reasoning: reasoning_score
            knowledge: knowledge_test_score
            adaptability: adaptability_score
            output: output_score
            compliance: structure_score + metadata_score
          strengths: strengths
          weaknesses: weaknesses
          recommendations: recommendations
          confidence: confidence_score

      - id: 5.5
        action: save_result
        path: "./memory/evaluations/{target_agent}-{timestamp}.md"
        update_context: true

# ════════════════════════════════════════════════════════════════════
# DISPLAY TEMPLATE
# ════════════════════════════════════════════════════════════════════
display:
  header: |
    ╔═══════════════════════════════════════════════════════════════╗
    ║  AGENT INTELLIGENCE REPORT                                     ║
    ╠═══════════════════════════════════════════════════════════════╣
    ║  Agent: {agent}                                                ║
    ║  Score: {score}/100 ({grade})                                  ║
    ║  Level: {level}                                                ║
    ║  Confidence: {confidence}%                                     ║
    ╚═══════════════════════════════════════════════════════════════╝

  breakdown: |
    ╔═══════════════════════════════════════════════════════════════╗
    ║  DIMENSION BREAKDOWN                                           ║
    ├───────────────────────────────────────────────────────────────┤
    ║  Reasoning:      {reasoning}/25  {reasoning_bar}  {reasoning_pct}%  ║
    ║  Knowledge:      {knowledge}/20  {knowledge_bar}  {knowledge_pct}%  ║
    ║  Adaptability:   {adapt}/20      {adapt_bar}      {adapt_pct}%      ║
    ║  Output Quality: {output}/20     {output_bar}     {output_pct}%     ║
    ║  Compliance:     {compliance}/15 {compliance_bar} {compliance_pct}% ║
    ╚═══════════════════════════════════════════════════════════════╝

  findings: |
    ╔═══════════════════════════════════════════════════════════════╗
    ║  STRENGTHS                                                      ║
    ├───────────────────────────────────────────────────────────────┤
    {for strength in strengths}
    ║  ✓ {strength}                                                   ║
    {endfor}
    ╠═══════════════════════════════════════════════════════════════╣
    ║  AREAS FOR IMPROVEMENT                                          ║
    ├───────────────────────────────────────────────────────────────┤
    {for weakness in weaknesses}
    ║  ⚠ {weakness}                                                   ║
    {endfor}
    ╚═══════════════════════════════════════════════════════════════╝

  recommendations: |
    ╔═══════════════════════════════════════════════════════════════╗
    ║  RECOMMENDATIONS                                                ║
    ├───────────────────────────────────────────────────────────────┤
    {for i, rec in enumerate(recommendations)}
    ║  {i+1}. {rec}                                                   ║
    {endfor}
    ╚═══════════════════════════════════════════════════════════════╝
