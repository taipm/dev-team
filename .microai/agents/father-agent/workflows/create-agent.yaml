# Create Agent Workflow
# Extracted from father-agent for v2.0
# Updated for v2.2: Added mandatory Design Review phase

workflow:
  name: create-agent
  description: Tạo agent mới từ đầu (with Design Review)
  version: "2.0"

# ════════════════════════════════════════════════════════════════════
# PHASE 1: DISCOVERY
# ════════════════════════════════════════════════════════════════════
phases:
  - id: discovery
    name: Thu thập thông tin
    steps:
      - id: 1.1
        action: ask
        question: "Agent này sẽ chuyên về domain gì?"
        output: domain
        validation:
          required: true
          min_length: 10

      - id: 1.2
        action: ask
        question: "Target codebase/project là gì?"
        output: target_project
        validation:
          required: false

      - id: 1.3
        action: ask
        question: "Những patterns chính cần document?"
        output: patterns
        validation:
          required: true
          type: list

      - id: 1.4
        action: ask
        question: "Communication style mong muốn?"
        output: style
        options:
          - "Professional và formal"
          - "Friendly và casual"
          - "Teacher-like và methodical"
          - "Direct và concise"

  - id: validate
    name: Validate input
    steps:
      - id: 2.1
        action: check
        condition: "domain.specificity >= 3"
        error: "Domain chưa đủ specific. Hãy mô tả chi tiết hơn."

      - id: 2.2
        action: search
        target: ".microai/agents/"
        pattern: "**/*.md"
        check: overlap
        on_overlap:
          suggest: "Agent {existing} có overlap. Suggest extend thay vì create mới?"
          options:
            - extend_existing
            - create_anyway
            - cancel

# ════════════════════════════════════════════════════════════════════
# PHASE 3: DESIGN REVIEW (MANDATORY - v2.2)
# ════════════════════════════════════════════════════════════════════
  - id: design_review
    name: Design Review (Mandatory)
    description: Create design document and submit to Deep Thinking Team
    steps:
      - id: 3.1
        action: load_template
        template: "knowledge/16-design-document-template.md"
        output: design_template

      - id: 3.2
        action: generate
        type: design_document
        inputs:
          - domain
          - target_project
          - patterns
          - style
          - overlap_check_results
        template: design_template
        vars:
          operation_type: "create-agent"
          name: "{agent_name}"
          uuid: "{generate_uuid}"
          review_mode: "standard"
        output_path: ".microai/agents/father-agent/designs/{agent_name}-design.md"
        output: design_doc_path

      - id: 3.3
        action: display
        type: info
        template: |
          ╔═══════════════════════════════════════════════════════════════╗
          ║  DESIGN DOCUMENT CREATED                                       ║
          ╠═══════════════════════════════════════════════════════════════╣
          ║  Agent: {agent_name}                                           ║
          ║  Path: {design_doc_path}                                       ║
          ║                                                                ║
          ║  Submitting to Deep Thinking Team for mandatory review...     ║
          ╚═══════════════════════════════════════════════════════════════╝

      - id: 3.4
        action: determine_review_mode
        criteria:
          deep:
            - has_complex_workflows: true
            - knowledge_count: ">5"
          standard:
            - default: true
        output: review_mode

      - id: 3.5
        name: "Submit to Deep Thinking Team"
        action: invoke_skill
        skill: "microai:deep-thinking"
        args:
          problem: |
            Review this agent design:

            Agent: {agent_name}
            Domain: {domain}
            Purpose: Create new agent

            Design Document: {design_doc_path}

            Key questions:
            1. Is this design sound and follows v2.0 spec?
            2. Any critical risks or missing components?
            3. Better alternatives or improvements?
          mode: "{review_mode}"
        output: review_result

      - id: 3.6
        action: parse_review
        input: review_result
        output: review_status
        # Expected: approved, rejected, approved-with-conditions

      - id: 3.7
        name: "Approval Gate"
        action: branch
        on: review_status
        cases:
          approved:
            - action: display
              message: |
                ╔═══════════════════════════════════════════════════════════════╗
                ║  DESIGN APPROVED ✓                                            ║
                ║  Proceeding with agent creation...                            ║
                ╚═══════════════════════════════════════════════════════════════╝
            - action: update_design_doc
              path: "{design_doc_path}"
              field: status
              value: "approved"
            - action: continue

          rejected:
            - action: display
              message: |
                ╔═══════════════════════════════════════════════════════════════╗
                ║  DESIGN REJECTED ✗                                            ║
                ╠═══════════════════════════════════════════════════════════════╣
                ║  Reason: {review_result.rejection_reason}                     ║
                ║                                                                ║
                ║  Action Required: Revise design and resubmit                  ║
                ║  (Skip is NOT allowed)                                        ║
                ╚═══════════════════════════════════════════════════════════════╝
            - action: update_design_doc
              path: "{design_doc_path}"
              field: status
              value: "rejected"
            - action: goto
              target: 3.1
              # Loop back to revise design - NO SKIP ALLOWED

          approved-with-conditions:
            - action: display
              message: |
                ╔═══════════════════════════════════════════════════════════════╗
                ║  DESIGN APPROVED WITH CONDITIONS                              ║
                ╠═══════════════════════════════════════════════════════════════╣
                {for condition in review_result.conditions}
                ║  - {condition}                                                ║
                {endfor}
                ╚═══════════════════════════════════════════════════════════════╝
            - action: apply_conditions
              conditions: review_result.conditions
            - action: update_design_doc
              path: "{design_doc_path}"
              field: status
              value: "approved-with-conditions"
            - action: continue

# ════════════════════════════════════════════════════════════════════
# PHASE 4: STRUCTURE (renumbered from Phase 2)
# ════════════════════════════════════════════════════════════════════
  - id: structure
    name: Tạo cấu trúc
    steps:
      - id: 4.1
        action: mkdir
        path: ".microai/agents/{agent_name}/"

      - id: 4.2
        action: mkdir
        path: ".microai/agents/{agent_name}/knowledge/"

      - id: 4.3
        action: mkdir
        path: ".microai/agents/{agent_name}/workflows/"
        condition: has_complex_workflows

# ════════════════════════════════════════════════════════════════════
# PHASE 5: CONTENT GENERATION (renumbered from Phase 3)
# ════════════════════════════════════════════════════════════════════
  - id: content
    name: Generate content
    steps:
      - id: 5.1
        action: load_template
        template: "knowledge/01-agent-template.md"
        output: agent_template

      - id: 5.2
        action: generate
        type: agent_definition
        inputs:
          - domain
          - target_project
          - patterns
          - style
        template: agent_template
        output_path: ".microai/agents/{agent_name}/agent.md"

      - id: 5.3
        action: generate_knowledge
        for_each: patterns
        template: "knowledge/03-knowledge-template.md"
        naming: "{index:02d}-{pattern_name}.md"
        output_path: ".microai/agents/{agent_name}/knowledge/"

      - id: 5.4
        action: generate
        type: knowledge_index
        template: "knowledge/04-index-template.yaml"
        output_path: ".microai/agents/{agent_name}/knowledge/knowledge-index.yaml"

# ════════════════════════════════════════════════════════════════════
# PHASE 6: REGISTRATION (2-Step) (renumbered from Phase 4)
# ════════════════════════════════════════════════════════════════════
  - id: registration
    name: Register command
    steps:
      - id: 6.1
        action: load_template
        template: "knowledge/02-command-template.md"
        output: command_template

      - id: 6.2
        name: "Step 1 - BUILD: Create in library"
        action: write
        content: command_template
        path: ".microai/commands/{agent_name}.md"

      - id: 6.3
        name: "Step 2 - REGISTER: Copy to runtime"
        action: copy
        source: ".microai/commands/{agent_name}.md"
        dest: ".claude/commands/microai/{agent_name}.md"

# ════════════════════════════════════════════════════════════════════
# PHASE 7: VERIFICATION (renumbered from Phase 5)
# ════════════════════════════════════════════════════════════════════
  - id: verification
    name: Verify creation
    steps:
      - id: 7.1
        action: check_files
        paths:
          - ".microai/agents/{agent_name}/agent.md"
          - ".microai/commands/{agent_name}.md"
          - ".claude/commands/microai/{agent_name}.md"
        on_missing: error

      - id: 7.2
        action: validate
        script: ".microai/scripts/validate-agent-v2.sh"
        args: ["{agent_name}"]

      - id: 7.3
        name: "Archive Design Document"
        action: move
        source: ".microai/agents/father-agent/designs/{agent_name}-design.md"
        dest: ".microai/agents/father-agent/designs/archive/{date}-create-agent-{agent_name}.md"

      - id: 7.4
        action: display
        type: summary
        template: |
          ╔═══════════════════════════════════════════════════════════════╗
          ║  AGENT CREATED SUCCESSFULLY                                    ║
          ╠═══════════════════════════════════════════════════════════════╣
          ║  Name: {agent_name}                                            ║
          ║  Path: .microai/agents/{agent_name}/                           ║
          ║  Command: /microai:{agent_name}                                ║
          ║                                                                 ║
          ║  Files created:                                                 ║
          ║    - agent.md                                                   ║
          ║    - knowledge/{count} files                                    ║
          ║    - command registered                                         ║
          ║                                                                 ║
          ║  Design Review: PASSED ✓                                       ║
          ║  Design Doc: designs/archive/{date}-create-agent-{agent_name} ║
          ║                                                                 ║
          ║  Test: Gõ /microai:{agent_name} để test                        ║
          ╚═══════════════════════════════════════════════════════════════╝

# ════════════════════════════════════════════════════════════════════
# OPTIONAL: MEMORY SETUP (renumbered)
# ════════════════════════════════════════════════════════════════════
  - id: memory_setup
    name: Setup memory (optional)
    condition: user_wants_memory
    steps:
      - id: 8.1
        action: mkdir
        path: ".microai/agents/{agent_name}/memory/"

      - id: 8.2
        action: write
        template: "knowledge/06-memory-template.md"
        files:
          - context.md
          - decisions.md
          - learnings.md
        path: ".microai/agents/{agent_name}/memory/"

      - id: 8.3
        name: "Link Design Document to Memory"
        action: write
        content: |
          # Design Origin

          This agent was created with the following design document:

          - **Design Doc**: `../../../father-agent/designs/archive/{date}-create-agent-{agent_name}.md`
          - **Reviewed by**: Deep Thinking Team
          - **Status**: Approved
          - **Created**: {date}
        path: ".microai/agents/{agent_name}/memory/design-origin.md"

# ════════════════════════════════════════════════════════════════════
# ERROR HANDLING
# ════════════════════════════════════════════════════════════════════
error_handling:
  on_validation_error:
    action: rollback
    message: "Validation failed. Rolling back changes."

  on_file_exists:
    action: ask
    question: "File đã tồn tại. Overwrite?"
    options:
      - overwrite
      - skip
      - cancel

  on_cancel:
    action: cleanup
    message: "Operation cancelled. Cleaning up..."
