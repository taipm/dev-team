# Step 04: Output Synthesis

## Objective
Generate security report based on session mode và findings.

## Output Types by Mode

| Mode | Primary Output |
|------|----------------|
| review | Security Review Report |
| threat-model | Threat Model Document |
| vulnerability | Vulnerability Assessment Report |

## Synthesis Flow

```
1. Compile all findings from dialogue
2. Calculate severity distribution
3. Generate appropriate report
4. Present to both agents for sign-off
5. If changes needed → iterate
6. If approved → finalize
```

## Output Templates

### Security Review Report

```markdown
# Security Code Review Report

## Session Info
- **Session ID**: {session_id}
- **Date**: {date}
- **Target**: {feature/code reviewed}
- **Reviewer**: Security Engineer

## Executive Summary

{2-3 sentence summary of overall security posture}

### Findings Summary

| Severity | Count |
|----------|-------|
| Critical | {count} |
| High | {count} |
| Medium | {count} |
| Low | {count} |
| Info | {count} |

## Detailed Findings

### Critical Findings

#### [C1] {Finding Title}
- **Severity**: Critical
- **Category**: {OWASP category}
- **Location**: {file:line}
- **Issue**: {description}
- **Risk**: {what could happen}
- **Attack Vector**: {how to exploit}
- **Recommendation**: {fix}
- **Status**: {Open/Fixed}
- **Developer Response**: {response}

### High Findings
[Similar structure]

### Medium Findings
[Similar structure]

### Low Findings
[Similar structure]

### Informational
[Similar structure]

## Positive Observations

1. {What's done well}
2. {Good security practice observed}

## Recommendations

### Immediate Actions (Critical/High)
1. {Recommendation}
2. {Recommendation}

### Short-term Actions (Medium)
1. {Recommendation}

### Long-term Improvements
1. {Recommendation}

## Sign-off

| Role | Status | Date |
|------|--------|------|
| Security Engineer | ✅ | {date} |
| Developer | ✅ | {date} |

---
Generated by Dev-Security Team Simulation
Session ID: {session_id}
```

### Threat Model Document

```markdown
# Threat Model: {System Name}

## Session Info
- **Session ID**: {session_id}
- **Date**: {date}
- **System**: {system_name}
- **Methodology**: STRIDE

## System Overview

{Description of the system}

### Data Flow Diagram

```
[DFD from session]
```

### Assets
| Asset | Sensitivity | Description |
|-------|-------------|-------------|
| {asset} | {H/M/L} | {description} |

### Trust Boundaries
1. {Boundary 1}
2. {Boundary 2}

### Entry Points
| Entry Point | Auth Required | Description |
|-------------|---------------|-------------|
| {entry} | {Yes/No} | {description} |

## STRIDE Analysis

### Spoofing Threats
| ID | Threat | Risk | Mitigation | Status |
|----|--------|------|------------|--------|
| S1 | {threat} | {H/M/L} | {mitigation} | {status} |

### Tampering Threats
| ID | Threat | Risk | Mitigation | Status |
|----|--------|------|------------|--------|
| T1 | {threat} | {H/M/L} | {mitigation} | {status} |

### Repudiation Threats
| ID | Threat | Risk | Mitigation | Status |
|----|--------|------|------------|--------|
| R1 | {threat} | {H/M/L} | {mitigation} | {status} |

### Information Disclosure Threats
| ID | Threat | Risk | Mitigation | Status |
|----|--------|------|------------|--------|
| I1 | {threat} | {H/M/L} | {mitigation} | {status} |

### Denial of Service Threats
| ID | Threat | Risk | Mitigation | Status |
|----|--------|------|------------|--------|
| D1 | {threat} | {H/M/L} | {mitigation} | {status} |

### Elevation of Privilege Threats
| ID | Threat | Risk | Mitigation | Status |
|----|--------|------|------------|--------|
| E1 | {threat} | {H/M/L} | {mitigation} | {status} |

## Risk Summary

### Risk Matrix
```
        │  Low Impact  │  Med Impact  │  High Impact │
High L  │      -       │      -       │      -       │
Med L   │      -       │      -       │      -       │
Low L   │      -       │      -       │      -       │
```

### Top Risks
1. {Risk 1} - {mitigation status}
2. {Risk 2} - {mitigation status}

## Action Items

| # | Action | Owner | Priority | Status |
|---|--------|-------|----------|--------|
| 1 | {action} | {owner} | {P1/P2} | {status} |

## Sign-off

| Role | Status |
|------|--------|
| Security Engineer | ✅ |
| Developer | ✅ |

---
Generated by Dev-Security Team Simulation
Session ID: {session_id}
```

## Sign-off Process

```
1. Display report
2. AskUserQuestion: "Both agents approve?"
   Options:
   - "Approved" → Finalize
   - "Needs changes" → Specify changes
   - "Disputed findings" → Discuss specific findings

3. If changes needed → iterate
4. Repeat until approved
```

## AskUserQuestion for Sign-off

```javascript
AskUserQuestion({
  questions: [{
    question: "Security report ready. {findings_count} findings. Both agents approve?",
    header: "Sign-off",
    options: [
      { label: "Approved", description: "Finalize và save report" },
      { label: "Minor changes", description: "Chỉnh sửa nhỏ" },
      { label: "Disputed findings", description: "Thảo luận findings cụ thể" }
    ],
    multiSelect: false
  }]
})
```

## Next Step

→ Proceed to **step-05-session-close.md**
